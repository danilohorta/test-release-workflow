name: Create Release

on:
  workflow_call:
    inputs:
      commit:
        description: Branch, tag or commit hash
        type: string
        required: false
        default: main

      version-bump:
        description: |
          Optional version bump. One of: 'major', 'minor', 'patch', or 'auto'.
          - 'auto' (default): infer the bump from Conventional Commits since the last release; if none can be inferred, no release is created.
          - 'major': major version bump.
          - 'minor': minor version bump.
          - 'patch': patch version bump.
        type: string
        required: false
        default: auto

      dry-run:
        description: Run in preview mode. Shows the next version number without creating a tag or release.
        type: boolean
        required: false
        default: false

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit }}

      - name: Validate version-bump input
        run: |
          case "${VERSION_BUMP}" in
            auto|major|minor|patch) ;;
            *) echo "::error::manual-version-bump must be 'auto', 'major', 'minor' or 'patch'"; exit 1;;
          esac
        env:
          VERSION_BUMP: ${{ inputs.version-bump }}

      - name: Get inferred version bump
        id: get-inferred-version-bump
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: false
          default_prerelease_bump: false
          dry_run: true # Don't create tag, we do this later

      - name: Get release details
        id: get-release-details
        run: |
          echo "${{ inputs.version-bump }}"
          echo "new_tag: ${{ steps.get-inferred-version-bump.outputs.new_tag }}"
          echo "new_version: ${{ steps.get-inferred-version-bump.outputs.new_version }}"
          echo "previous_tag: ${{ steps.get-inferred-version-bump.outputs.previous_tag }}"
          echo "previous_version: ${{ steps.get-inferred-version-bump.outputs.previous_version }}"
          echo "release_type: ${{ steps.get-inferred-version-bump.outputs.release_type }}"
          echo "changelog: ${{ steps.get-inferred-version-bump.outputs.changelog }}"
      #
      # - name: Increment Version
      #   id: increment-version
      #   uses: christian-draeger/increment-semantic-version@1.2.3
      #   if: steps.get-release-details.outputs.release-type
      #   with:
      #     current-version: ${{ steps.get-auto-version-bump.outputs.previous_tag }}
      #     version-fragment: ${{ steps.get-release-details.outputs.release-type }}
      #
      # - name: Create Tag
      #   if: steps.get-release-details.outputs.make-release == 'true'
      #   run: |
      #     git tag "$VERSION"
      #     git push origin "$VERSION"
      #   env:
      #     VERSION: ${{ steps.increment-version.outputs.next-version }}
      #
      # - name: Create Release
      #   uses: softprops/action-gh-release@v2
      #   if: steps.get-release-details.outputs.make-release == 'true'
      #   with:
      #     name: ${{ steps.increment-version.outputs.next-version}}
      #     tag_name: ${{ steps.increment-version.outputs.next-version }}
      #     generate_release_notes: true
      #
      # - name: Create release summary
      #   run: |
      #     cat << EOF >> $GITHUB_STEP_SUMMARY
      #     ## üöÄ Release summary
      #
      #     Workflow was triggered from \`$GITHUB_REF_NAME\`
      #
      #     | Detail                     | Value                        |
      #     | -------------------------- | ---------------------------- |
      #     | üì¶ Make Release?           | \`$MAKE_RELEASE\`            |
      #     | üè∑Ô∏è New Version             | \`$NEW_VERSION\`             |
      #     | üìå Previous Version        | \`$PREVIOUS_VERSION\`        |
      #     | üîÑ Version Bump            | \`$VERSION_BUMP\`            |
      #     | üõ†Ô∏è Specified Manual Bump   | \`$MANUAL_BUMP\`             |
      #     | ü§ñ Auto Determined Bump    | \`$AUTO_BUMP\`               |
      #     EOF
      #
      #     echo "
      #     Release Summary:
      #     Make Release: $MAKE_RELEASE
      #     New Version: $NEW_VERSION
      #     Previous Version: $PREVIOUS_VERSION
      #     Version Bump: $VERSION_BUMP
      #     Specified Manual Bump: $MANUAL_BUMP
      #     Auto Determined Bump: $AUTO_BUMP
      #     "
      #   env:
      #     GITHUB_REF_NAME: ${{ github.ref_name }}
      #     MAKE_RELEASE: ${{ steps.get-release-details.outputs.make-release }}
      #     NEW_VERSION: ${{ steps.increment-version.outputs.next-version || 'None' }}
      #     PREVIOUS_VERSION: ${{ steps.get-auto-version-bump.outputs.previous_tag }}
      #     VERSION_BUMP: ${{ steps.get-release-details.outputs.release-type || 'None' }}
      #     MANUAL_BUMP: ${{ inputs.version-bump || 'None' }}
      #     AUTO_BUMP: ${{ steps.get-auto-version-bump.outputs.release_type || 'None' }}
      #
      # - name: Link to release summary
      #   run: |
      #     echo "
      #     View Release Summary at:
      #     https://github.com/$GITHUB_REPO/actions/runs/$GITHUB_RUN_ID
      #     "
      #   env:
      #     GITHUB_REPO: ${{ github.repository }}
      #     GITHUB_RUN_ID: ${{ github.run_id }}
